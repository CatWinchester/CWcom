<!DOCTYPE html>

<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/grid.css" />
    <link href="style.less" rel="stylesheet/less" type="text/css" />
    <script type="text/javascript" src="js/less-1.5.0.min.js"></script>
    <script src="http://code.jquery.com/jquery-2.0.3.js"></script>
    <script src="http://knockoutjs.com/downloads/knockout-2.3.0.js" ></script>
    <script src="js/backgroundModule.js" ></script>
    <title>Cat Winchester</title>
</head>
<body>
    <div id="content">
        <div class="section group" id="top_row" data-bind="template: { name: getTemplate, foreach:topRowPosts }" ></div>

        <div class="section group" id="main_row" data-bind="template: { name: getTemplate, foreach: mainRowPosts }"></div>
        
        <div class="section group" id="bottom_row" data-bind="template: { name: getTemplate, foreach: bottomRowPosts }"></div>
    </div>
    
    <canvas id="background"></canvas>
    
    <div style="clear:both;"></div>

    <script type="text/html" id="imagePost">
        <div class="col span_1_of_4">
            <div class="post">
                <div class="post_content">
                    <h2 data-bind="text: day"></h2>
                    <img data-bind="attr: { src: image }" />
                    <p data-bind="text: description"></p>

                    <div class="read_more_link">
                        <a href="#">Read more </a>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/html" id="canvasPost">
        <div class="col span_1_of_4">
            <div class="post">
                <div class="post_content">
                    <h2 data-bind="text: day"></h2>
                    <canvas data-bind="attr: { 'id': canvasId }" width=150></canvas>
                    <p data-bind="text: description"></p>

                    <div class="read_more_link">
                        <a href="#">Read more </a>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/javascript">
        function Post(day, header, description, template) {
            this.day = day;
            this.header = header;
            this.description = description;
            this.template = template;
        }        

        function ImagePost(day, header, description, image) {
            Post.call(this, day, header, description, 'imagePost');

            this.image = image;
        }

        ImagePost.prototype = Object.create(new Post());

        function CanvasPost(day, header, description, canvasId) {
            Post.call(this, day, header, description, 'canvasPost');

            this.canvasId = canvasId;
        }

        CanvasPost.prototype = Object.create(new Post());

        function BlogViewModel() {
            var self = this;

            var numberOfItemsInRow = 4;

            self.posts = ko.observableArray();

            self.getTemplate = function (post) {
                return post.template;
            }

            self.getRowPosts = function (rowIndex) {                
                var foundPosts = [];

                for (var i = numberOfItemsInRow * rowIndex;
                         i >= 0 &&
                         i < numberOfItemsInRow * rowIndex + numberOfItemsInRow &&
                         i < self.posts().length;
                         i++) {
                    foundPosts.push(self.posts()[i]);
                }

                return foundPosts;
            }

            self.getNumberOfRows = function () {
                var mod = self.posts().length % numberOfItemsInRow;

                if (mod != 0)
                    return (self.posts().length - mod) / numberOfItemsInRow + 1;
                else return self.posts().length / numberOfItemsInRow;
            };

            self.selectedRow = ko.observable();

            self.rowBeforeSelected = ko.computed(function () {                                                    
                return self.selectedRow() == 0 ? self.getNumberOfRows() == 1 ? null
                                                                             : self.getNumberOfRows() - 1
                                               : self.selectedRow() - 1;
            });
            
            self.rowAfterSelected = ko.computed(function () {
                return self.selectedRow() == self.getNumberOfRows() - 1 ? self.getNumberOfRows() == 1 ? null
                                                                                                      : 0
                                                                        : self.selectedRow() + 1;
            });
            
            self.mainRowPosts = ko.computed(function () {
                return self.getRowPosts(self.selectedRow());
            });

            self.topRowPosts = ko.computed(function () {
                return self.rowBeforeSelected() == null ? []
                                                        : self.getRowPosts(self.rowBeforeSelected());
            });

            self.bottomRowPosts = ko.computed(function () {
                return self.rowAfterSelected() == null ? []
                                                       : self.getRowPosts(self.rowAfterSelected());
            });

            self.moveUp = function () {
                if(self.rowAfterSelected() != null)
                    self.selectedRow(self.rowAfterSelected());
            };

            self.moveDown = function () {
                if (self.rowBeforeSelected() != null)
                    self.selectedRow(self.rowBeforeSelected());
            };
        }

        var vm = new BlogViewModel();

        vm.posts().push(new ImagePost("Day 1",
                                      "First version",
                                      "This is the first version of my site. It will be updated as often as new version is ready (hope every day:)).",
                                      "content/images/day1.jpg"),
                        new CanvasPost("Day 2",
                                       "Many days after...",
                                       "Bezier training",
                                       "bezier"));

        $('#content').bind('mousewheel',
                   function (e) {
                       if (e.originalEvent.wheelDelta > 0) {
                           vm.moveDown();
                       }
                       else {
                           vm.moveUp();
                       };
                   });
        	
        vm.selectedRow(0);

        ko.applyBindings(vm);

        backgroundModule.init('background');
    </script>
</body>
</html>