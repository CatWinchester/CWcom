<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <title>Simple Game</title>
    <style>
        body {
            margin:0;
            padding:0;
            text-align:center;
        }
        canvas {
            outline:0;
            border:1px solid #000;
            margin-left:auto;
            margin-right:auto;
        }
    </style>
</head>
<body>
    <canvas id="myCanvas" width="500" height="500"></canvas>
    
    <script>
        var context;
        var sizeX = 499;
        var sizeY = 499;
        
        var game = new Game(sizeX, sizeY);

        $(document).ready(function () {           
            document.body.onkeydown = function (evt) {
                evt = evt ?
                      evt :
                      window.event;

                if (evt.keyCode == 40) game.downKeyPressed = true;
                if (evt.keyCode == 38) game.upKeyPressed = true;
                if (evt.keyCode == 37) game.leftKeyPressed = true;
                if (evt.keyCode == 39) game.rightKeyPressed = true;
                if (evt.keyCode == 32) game.spaceKeyPressed = true;

                console.log(evt);
            };

            document.body.onkeyup = function (evt) {
                evt = evt ?
                    evt :
                      window.event;

                if (evt.keyCode == 40) game.downKeyPressed = false;
                if (evt.keyCode == 38) game.upKeyPressed = false;
                if (evt.keyCode == 37) game.leftKeyPressed = false;
                if (evt.keyCode == 39) game.rightKeyPressed = false;
                if (evt.keyCode == 32) game.spaceKeyPressed = false;
            };

            context = myCanvas.getContext('2d');
            setInterval(renderGame, 33);

        });

        function renderGame() {
            game.update();
            game.draw(context);           
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.round(Math.random() * 15)];
            }

            return color;
        }        

        function Circle(x, y, color, dx, dy, radius) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.dx = dx;
            this.dy = dy;
            this.radius = radius;

            this.draw = function (context) {
                context.beginPath();
                context.fillStyle = this.color;
                context.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
                context.closePath();
                context.fill();
            }

            this.update = function () {
                this.x += this.dx;
                this.y += this.dy;
            }
        }

        function Rectangle(x, y, color, dx, dy, width, height) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.dx = dx;
            this.dy = dy;
            this.height = height;
            this.width = width;

            this.draw = function (context) {
                context.beginPath();
                context.fillStyle = this.color;
                context.rect(this.x, this.y, this.width, this.height);
                context.closePath();
                context.fill();
            }

            this.update = function () {
                this.x += this.dx;
                this.y += this.dy;
            }
        }

        function Game(width, height) {
            this.rectangles = [];
            this.width = width;
            this.height = height;

            this.downKeyPressed = false;
            this.upKeyPressed = false;
            this.leftKeyPressed = false;
            this.rightKeyPressed = false;
            this.spaceKeyPressed = false;

            this.circle = new Circle(Math.random() * sizeX,
                                    Math.random() * sizeY,
                                    getRandomColor(),
                                    0,
                                    0,
                                    (Math.random() + 0.5) * 30);

            this.draw = function (context) {
                context.clearRect(0, 0, this.width, this.height); 

                this.circle.draw(context);

                for (var i = 0; i < this.rectangles.length; i++) {
                    this.rectangles[i].draw(context);
                }                
            }

            this.update = function () {

                if (this.circle.x < 0 || this.circle.x > this.width) this.circle.dx = -this.circle.dx;
                if (this.circle.y < 0 || this.circle.y > this.height) this.circle.dy = -this.circle.dy;

                if (this.downKeyPressed) this.circle.dy += 0.5;
                if (this.upKeyPressed) this.circle.dy -= 0.5;
                if (this.leftKeyPressed) this.circle.dx -= 0.5;
                if (this.rightKeyPressed) this.circle.dx += 0.5;

                this.circle.update();

                if (this.spaceKeyPressed) {
                    this.rectangles.push(new Rectangle(this.circle.x,
                                                       this.circle.y,
                                                       getRandomColor(),
                                                       0,
                                                       -2,
                                                       20,
                                                       40));
                }
                for (var i = 0; i < this.rectangles.length; i++) {
                    this.rectangles[i].update();
                }
            }
        }
    </script>
</body>
</html>