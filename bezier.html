<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/grid.css" />
    <script src="http://code.jquery.com/jquery-2.0.3.js"></script>
    <script src="http://knockoutjs.com/downloads/knockout-2.3.0.js" ></script>
    <title>Bezier</title>
    <style>
        #myScreen {
            border:2px solid #ff0000;
            display:block;
            margin:0 auto;
        }
    </style>
</head>
<body>
    <div class="section group">
        <div class="col span_4_of_4" >
            <canvas id="myScreen" width="1000" height="500"></canvas>
        </div>
    </div>


    <script>
        var canvas = document.getElementById('myScreen');
        var ctx = canvas.getContext('2d');
        var sizeX = 1000;
        var sizeY = 500;
        var interval = 20; //как часто обновлять экран(милисекунды)

        var isDrag = false;
        var mx, my; //координаты мышки

        var bezierVertexes = [];
        var linesBetweenVertexes = [];

        function getRandomColor() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.round(Math.random() * 15)];
            }
            return color;
        }

        function fact(n) {
            return n < 2 ? 1
                         : n * fact(n - 1);
        }

        function BezierVertex(x, y, width, height, fillColor) {
            this.x = x;
            this.y = y;
            this.width = width;
            this.height = height;
            this.fillColor = fillColor;

            this.draw = function (context) { 
                context.beginPath();
                context.fillStyle = this.fillColor;
                context.rect(this.x, this.y, this.width, this.height);
                context.closePath();
                context.fill();
            }
        }

        function Point(x, y) {
            this.x = x;
            this.y = y;
        }

        function LineBetweenVertexes(x, y, xTo, yTo, color) {
            this.x = x;
            this.y = y;
            this.xTo = xTo;
            this.yTo = yTo;
            this.color = color;

            this.draw = function (context) {
                context.beginPath();
                context.moveTo(this.x, this.y);
                context.lineTo(this.xTo, this.yTo);
                context.strokeStyle = color;
                context.stroke();
                context.closePath();
            }
        }

        //опорные точки
        var vertexX0 = 80,  vertexY0 = 130, //P0
            vertexX1 = 150, vertexY1 = 30,  //P1
            vertexX2 = 260, vertexY2 = 120, //P2
            vertexX3 = 320, vertexY3 = 60, //P3
            vertexX4 = 380, vertexY4 = 120;  //P4
            vertexX5 = 480, vertexY5 = 20; //P5

        bezierVertexes.push(new BezierVertex(vertexX0, vertexY0, 10, 10, getRandomColor()),
                            new BezierVertex(vertexX1, vertexY1, 10, 10, getRandomColor()),
                            new BezierVertex(vertexX2, vertexY2, 10, 10, getRandomColor()),
                            new BezierVertex(vertexX3, vertexY3, 10, 10, getRandomColor()),
                            new BezierVertex(vertexX4, vertexY4, 10, 10, getRandomColor()),
                            new BezierVertex(vertexX5, vertexY5, 10, 10, getRandomColor()));

        linesBetweenVertexes.push(new LineBetweenVertexes(vertexX0, vertexY0, vertexX1, vertexY1, getRandomColor()),
                                  new LineBetweenVertexes(vertexX1, vertexY1, vertexX2, vertexY2, getRandomColor()),
                                  new LineBetweenVertexes(vertexX2, vertexY2, vertexX3, vertexY3, getRandomColor()),
                                  new LineBetweenVertexes(vertexX3, vertexY3, vertexX4, vertexY4, getRandomColor()),
                                  new LineBetweenVertexes(vertexX4, vertexY4, vertexX5, vertexY5, getRandomColor()));

        function CalculateBezierPoint(vertices, t) {
            var x = 0;
            var y = 0;

            for (var i = 0; i < vertices.length; i++) {
                var bazis = fact(vertices.length - 1) / (fact(i) * fact(vertices.length - 1 - i)) *
                           Math.pow(t, i) * Math.pow(1 - t, vertices.length - 1 - i);

                x += vertices[i].x * bazis;

                y += vertices[i].y * bazis;
            }

            return new Point(x, y);
        }

        function BezierSpline(context) {
            context.beginPath();
            context.moveTo(vertexX0, vertexY0);
            for (t = 0; t <= 1; t += 0.01) {
                var point = CalculateBezierPoint(bezierVertexes, t);
                ctx.lineTo(point.x, point.y);
                ctx.stroke();
            }
            context.closePath();
        }

        var dragging = false;
        var dragHoldX;
        var dragHoldY;
        var dragindex;

        canvas.addEventListener("mousedown", mouseDownListener, false);

        function mouseDownListener(evt) {
            //для того что бы тянуть только верхний элемент
            var highestIndex = -1;
            var rect = canvas.getBoundingClientRect();
            var mouseX = (evt.clientX - rect.left) * (canvas.width / rect.width);
            var mouseY = (evt.clientY - rect.top) * (canvas.height / rect.height);

            //ищем элемент на который кликнули
            for (var i = 0; i < bezierVertexes.length; i++) {
                if (mouseX > bezierVertexes[i].x &&
                    mouseX < bezierVertexes[i].width &&
                    mouseY > bezierVertexes[i].y &&
                    mouseY < bezierVertexes[i].height) {
                    dragging = true;
                    
                    if (i > highestIndex) {
                        //обратим внимание на точку за которую мы дерижим обьект
                        dragHoldX = mouseX - bezierVertexes[i].x;
                        dragHoldY = mouseY - bezierVertexes[i].y;
                        highestIndex = i;
                        dragIndex = i;
                    }
                    console.log("mouse down");
                }
            }
            if (dragging) {
                window.addEventListener("mousemove", mouseMoveListener, false);
            }

            canvas.removeEventListener("mousedown", mouseDownListener, false);
            window.addEventListener("mouseup", mouseUpListener, false);
        }

        function mouseUpListener(evt) {
            canvas.addEventListener("mousedown", mouseDownListener, false);
            window.removeEventListener("mouseup", mouseUpListener, false);
            if (dragging) {
                dragging = false;
                window.removeEventListener("mousemove", mouseMoveListener, false);
            }
        }

        function mouseMoveListener(evt) {
            var posX;
            var posY;

            var rect = canvas.getBoundingClientRect();
            var mouseX = (evt.clientX - rect.left) * (canvas.width / rect.width);
            var mouseY = (evt.clientY - rect.top) * (canvas.height / rect.height);

            posX = mouseX - dragHoldX;
            posY = mouseY - dragHoldY;


            bezierVertexes[dragIndex].x = posX;
            bezierVertexes[dragIndex].y = posY;

            bigDrawing(ctx);
        }

        function bigDrawing(context) {
            context.clearRect(0, 0, sizeX, sizeY);

            for (var i = 0; i < bezierVertexes.length; i++) {
                bezierVertexes[i].draw(context);
            }

            for (var i = 0; i < linesBetweenVertexes.length; i++) {
                linesBetweenVertexes[i].draw(context);
            }
            BezierSpline(context);
        }

        bigDrawing(ctx);
     
    </script>
</body>
</html>